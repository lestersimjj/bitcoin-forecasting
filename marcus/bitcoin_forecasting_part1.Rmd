---
title: "Bitcoin Forecasting"
author: "Marcus Cheong Wei Ze"
date: "21/11/2020"
output: 
---

# **Load Packages**
```{r,echo=FALSE, collapse=TRUE, message=FALSE}
options(scipen = 99)
library(dplyr)
library(tidyverse)
library(stringr)
library(almanac)
library(lubridate)
library(Quandl)
library(gtrendsR)
library(RcppRoll)
library(xgboost)
library(MLmetrics)
library(pageviews)
library(quantmod)
library("doFuture"); registerDoFuture(); plan(multiprocess)
library(tidyquant)
library(tidymodels)
library(tsfeatures)
library(slider)
library(timetk)
library(data.table)
library(grid)
library(plotly) #for candlestick plot
library(hablar) #for bollinger band analysis

```

# **Scrape/Download Data**

## **Additional Features added (to consider)**
### **Import the scrapped Bitcoin News Articles - Sentiments**

* This is included because I feel that on top of technical analysis, sentiment analysis is also equally important. Although there is scraping of google hits, sentiments gathered from news articles can also be a possible feature to consider. This is because it can give us a general idea of people's opinions and sentiments about Bitcoin, which may be an equally good indicator as to how frequent people search bitcoin on the search engine.

* This is to see if a positive/negative news will affect the next day or current day price of Bitcoin. The idea is to monitor the public mood about the Bitcoin market or perhaps if the Bitcoin prices will be affected by certain new regulations introduced. We can then see if there is any correlation between the sentiment and the closing price of bitcoin, and hopefully will add value to the model we are building to predict future prices of Bitcoin and give a recommendation if it is the right time to enter and buy Bitcoin.

* Disclaimer and limitations in the news articles scrapped are mentioned in the 'Bitcoin News Analytics' RMarkdown.
* The websites where the scrapping of news articles are done are also mentioned in that RMarkdown. 2 news site are used, though there may be concerns about the biasness of articles because it is taken from Bitcoin related websites, but results shown there are mixed sentiments on Bitcoin from the articles on those 2 websites chosen. There is no clear swayness towards positivity on Bitcoin.

```{r}
news_articles_sentiments_bing <- read.csv("bitcoin_sentiment_bing.csv")
news_articles_sentiments_bing <- news_articles_sentiments_bing[-c(1)] # drop first column

news_articles_sentiments_afinn <- read.csv("bitcoin_sentiment_afinn.csv")
news_articles_sentiments_afinn <- news_articles_sentiments_afinn[-c(1)] # drop first column

news_articles_sentiments_sentimentr <- read.csv("bitcoin_sentiment_sentimentr.csv")
news_articles_sentiments_sentimentr <- news_articles_sentiments_sentimentr[-c(1)] # drop first column

```

## **Federal Funds Rate**

* Besides all the data that's scrapped, a research paper [#insert ref] has revealed that Federal Funds Rate is a possible influence on Bitcoin prices. FFR is the target interest rate set by the FOMC at which commercial banks borrow and lend their excess reserves to each other overnight. FOMC sets a target federal funds rate eight times a year, based on prevailing economic conditions.

* As an investment asset, the US Federal Reserve’s Interest Rate Policy can have certain impact on Bitcoin price. Increase in the FFR may have adverse impact on Bitcoin price based on the following two assumptions: rise in US dollar and reduce in speculative investments. 
  + First, the US dollar will benefit from the rate increase because raising interest rates may lead to capital flow back to the US market therefore cause Bitcoin price fell. 
  + Second, increase in interest rate could reduce speculative investments. 
* The data was downloaded from <a href="https://fred.stlouisfed.org/series/EFFR" target="_blank">this site</a>
  
```{r}
fedfundsrate <- read.csv("fedfundsrate.csv")
fedfundsrate$DATE <- as.Date(fedfundsrate$DATE)
fedfundsrate <- subset(fedfundsrate, DATE>=as.Date("2011-09-13"))
colnames(fedfundsrate) <- c("date", "effr")
fedfundsrate$effr[fedfundsrate$effr=="."] <- NA
fedfundsrate <- fedfundsrate %>% map_df(na.locf)
fedfundsrate$effr <- as.numeric(fedfundsrate$effr)

```

# **Feature Engineering**

## BITCOIN PRICE DATA

### Cleaning Bitcoin Prices
```{r}
bitcoin_price[bitcoin_price == 0] <- NA
bitcoin_price <- bitcoin_price %>% map_df(na.locf)

```

### Define Target

* The future return was changed to **log returns** instead of arithmetic returns. Arithmetic return has a positive bias. To eliminate this bias a log return is preferred. It removes this bias and puts all the numbers in a log plane, and in the process also normalizing the returns to log normal. 

```{r}
bitcoin_model <- bitcoin_price %>%
  tq_mutate(select = close,
            mutate_fun = periodReturn,
            period = 'daily',
            type = 'log',                            
            col_rename = 'future_return') %>%
  mutate(future_return_sign = as.factor(ifelse(future_return > 0, 1, 0)),
         close = lag(close, 1),
         date = date - days(1)) %>%
  select(date, close, future_return, future_return_sign) 

bitcoin_model <- bitcoin_model[-1, ]

```

## **Additional Features added (to consider)**

### **Bollinger Bands**

* The two main goals of this indicator are to convey the market message on the volatility and to define high (resistance) or low (support) on a relative basis. 
* If the price action hits the upper Bollinger Band, the tool suggests that the asset is overbought and that we may see a rotation from the current levels.
* Bollinger Bands are a price-performance forecasting model revolving around the 20-day simple moving average (SMA) of an asset. The SMA has an upper and lower band around it, which analysts plot using standard deviation.
* As volatility increases, so the bands become further apart. In times of low volatility, the bands contract, or “squeeze.”
* When the two outer lines are contracting and narrowing down, the volatility is lower, which usually means that the market is ranging and consolidating – the so-called “Bollinger Band squeeze”.
* A sharp change in the market behavior is likely to lead towards the squeeze breakout. 

```{r}
# create Bollinger Bands
bitcoin_price_data <- bitcoin_price
library(hablar)
bitcoin_price_data <- bitcoin_price_data %>% 
  convert(num(open:weighted_price))
bbands <- BBands(bitcoin_price_data[,c("high","low","close")]) #dn - The lower bollinger band, mavg - middle moving average, up - the upper bollinger band

# join and subset data
date_band <- "2011-09-13"
df_1 <- subset(cbind(bitcoin_price, data.frame(bbands[,1:3])), date >= date_band)
row.names(df_1) <- NULL

```

```{r}
# Find Bollinger Band Width
# Band Width = (Upper Bollinger Band - Lower Bollinger Band) / Middle Bollinger Band
# According to John Bollinger, the fall in the Bollinger Bandwidth indicator below 2% or 0.02 has led to big moves in the S&P500 index. Let's see if there is any similarity to the Bitcoin market.
# if the width becomes narrower, it indicates that it will expands next which signals buy
df_1 <- df_1 %>% mutate(bb_width = (up-dn)/mavg)

```

```{r}
bb_df <- df_1 %>% select(c(date,bb_width))
bitcoin_model <- bitcoin_model %>% left_join(bb_df)

```


## **Relative Strength Index (RSI)**

* RSI is a momentum oscillator that measures the speed and change of price movements. 
* It oscillates between zero and 100. 
* According to Wilder, RSI is considered overbought when > 70 and oversold when < 30.

```{r}
bitcoin_model_date <- as.data.frame(bitcoin_model$date)
rsi <- as.data.frame(RSI(bitcoin_model$close,14))
rsi <- cbind(bitcoin_model_date,rsi)
colnames(rsi) <- c("date","rsi")
bitcoin_model <- bitcoin_model %>% left_join(rsi)

```

## **MACD (Moving Average Convergence/Divergence)**
* Buy signal arises when MACD crosses from below to above the signal line. (bullish signal) - price of the bitcoin is likely to experience upward momentum
* Sell signal arises when MACD crosses from above to below the signal line. (bearish signal)

```{r}
# Usually, K = 9 days,  S = 12 days and L = 26 days

myMACD <- function (x,price,S,L,K){
  MACD <- EMA(price,S) - EMA(price,L)
  signal <- EMA(MACD,K)
  date <- x[,1]
  price <- price
  output <- cbind(date,price, MACD,signal)
  colnames(output) <- c("date","closing_price", "MACD","signal")
  return(output)
}

macd <- myMACD(bitcoin_price,Cl(bitcoin_price), 12, 26,9)
tail(macd,n=5)

macd <- macd %>% mutate(macd_signal_dist = MACD-signal)

```

```{r}
# Since it was mentioned that traders use the MACD’s histogram to identify when bullish or bearish momentum is high, so we will only extract the distance calculated (MACD-signal) column to add into the bitcoin model.
macd_df <- macd %>% select(c(date,macd_signal_dist))
bitcoin_model <- bitcoin_model %>% left_join(macd_df)

```

## **Accumulation/Distribution Indicator**

* The accumulation/distribution measure seeks to identify divergences between the stock price and volume flow. 
* This provides insight into how strong a trend is. 
* If the price is rising but the indicator is falling this indicates that buying or accumulation volume may not be enough to support the price rise and a price decline could be forthcoming.
* A rising A/D line helps confirm a rising price trend.
* A falling A/D line helps confirm a price downtrend.
* If the price is rising but A/D is falling, it signals underlying weakness and a potential decline in price.
* If the price of an asset is falling but A/D is rising, it signals underlying strength and the price may start to rise.

```{r}
acu_dis_df <- bitcoin_price
acu_dis_df <- acu_dis_df %>% mutate(cmfv = ((bitcoin_price$close-bitcoin_price$low)-(bitcoin_price$high-bitcoin_price$close))/(bitcoin_price$high-bitcoin_price$low)*bitcoin_price$volume_currency)
acu_dis_df$cmfv[is.na(acu_dis_df$cmfv)] <- 0
acu_dis_df <- acu_dis_df %>% mutate(cumulative_cmfv = cumsum(cmfv))

```

```{r}

acu_dis_df_add <- acu_dis_df %>% select(date,cumulative_cmfv)
bitcoin_model <- bitcoin_model %>% left_join(acu_dis_df_add)

```

## **Bitcoin News Sentiments**

```{r}
# "bing"
colnames(news_articles_sentiments_bing) <- c("date","positive_sentiment_bing")
news_articles_sentiments_bing$date <- as.Date(news_articles_sentiments_bing$date)
bitcoin_model <- bitcoin_model %>% 
  left_join(news_articles_sentiments_bing)

# "Afinn"
colnames(news_articles_sentiments_afinn) <- c("date","positive_sentiment_afinn")
news_articles_sentiments_afinn$date <- as.Date(news_articles_sentiments_afinn$date)
bitcoin_model <- bitcoin_model %>% 
  left_join(news_articles_sentiments_afinn)

```

```{r}
#Using sentimentr

news_articles_sentiments_sentimentr_extract <- select(news_articles_sentiments_sentimentr,c(article_date,ave_sentiment))
news_articles_sentiments_sentimentr_extract <- news_articles_sentiments_sentimentr_extract %>%
  mutate(positive_sentiment_sentimentr = ifelse(ave_sentiment>0,1,0))
news_articles_sentiments_sentimentr_extract  <- select(news_articles_sentiments_sentimentr_extract, c(article_date,positive_sentiment_sentimentr))
setnames(news_articles_sentiments_sentimentr_extract, "article_date", "date")
news_articles_sentiments_sentimentr_extract$date <- as.Date(news_articles_sentiments_sentimentr_extract$date)
bitcoin_model <- bitcoin_model %>% 
  left_join(news_articles_sentiments_sentimentr_extract)

```


## **Fed Funds Rate**

```{r}
bitcoin_model <- bitcoin_model %>% left_join(fedfundsrate)
bitcoin_model <- bitcoin_model %>% fill(effr,.direction = "down")

```

